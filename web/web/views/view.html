<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="dist/css/adminlte.css">
    <style>
    .imgtrans {
        bottom: 0;
        display: flex;
        flex-direction: column;
        margin: 0 20px 0 -20px;
        position: fixed;
        right: 0;
        width: auto;
        z-index: 9998;
        align-items: flex-end;
        justify-content: flex-end;
    }
    .imgtrans2 {
        bottom: 0;
        display: flex;
        flex-direction: column;
        margin: 0 150px 10px 0;
        position: fixed;
        right: 0;
        width: auto;
        z-index: 9997;
        align-items: flex-end;
        justify-content: flex-end;
        line-height: normal;
    }
    .imgtrans3 {
        bottom: 0;
        display: flex;
        flex-direction: column;
        margin: 0 530px 10px 0;
        position: fixed;
        right: 0;
        width: auto;
        z-index: 9996;
        align-items: flex-end;
        justify-content: flex-end;
    }
    .imgtrans4 {
        bottom: 0;
        display: flex;
        flex-direction: column;
        margin: 0 150px 10px 0;
        position: fixed;
        right: 0;
        width: auto;
        z-index: 9995;
        align-items: flex-end;
        justify-content: flex-end;
    }
    </style> 
    <script src="https://dathoc.net/apiroot.js" type="text/javascript"></script>
</head>
<body>
<p id='stream'></p> 
<script src="./dist/js/jquery-3.6.0.min.js"></script>
<script src="./dist/js/cs.js"></script>
<script src="./socketio/socket.io.js" type="text/javascript"></script>
<script src="wt_api_e_.js"></script>
<script src="./dist/js/reactchat.js"></script>

<div class="imgtrans3" id="loadingx">
    <img src="img/ld.gif" style="width: 20%; padding: 0px; align: justify;">
</div>


<div class="imgtrans" id="xraycontrol">
    <div class="d-flex justify-content-right" style="padding-bottom: 8px;">
        <input type="file" name="img[]" class="file" accept="image/*">
        <input type="text" class="form-control" style="width:150px" disabled placeholder="Ảnh..." id="file">
        &nbsp;&nbsp;&nbsp;
        <button type="button" id="btnSearchImg" class="btn btn-info" >Xét XQuang</button>
        &nbsp;&nbsp;&nbsp;
        <button type="button" id="btnSendImg" class="btn btn-info" >Gửi ảnh</button>
        &nbsp;&nbsp;&nbsp;
        <button type="button" id="btnReset" class="btn btn-info" >Ẩn</button>
        <button type="button" id="btnView" class="btn btn-info" >Hiện</button>
    </div>
    <div class="d-flex justify-content-right">
        <input type="email" class="form-control" id="inkl" style="width:450px" autocomplete="on" placeholder="Dữ liệu kinh lạc, vd: tp35.3-tp36-tp35.2-tt34-tt33-cp32.5-ct-33" name="email"></input>
        &nbsp;&nbsp;&nbsp;
        <button type="button" id="btnkl" class="btn btn-info" >Xét kinh lạc</button>
    </div>    
</div>

<div class="imgtrans2" id="xrayview">
    <div class="d-flex justify-content-right">
        <div class="position-relative mb-4">
            <div id= "textdect">
    
            </div>
        </div> 
        <div class="position-relative mb-4">
            <div id= "previewImg">
                
            </div>
        </div>
        <div class="position-relative mb-4">
            <div id= "arrresult">
    
            </div>
        </div> 
        
    </div>
  
</div>
<div class="imgtrans4" id="klview">
    <div class="d-flex justify-content-right">
        <div class="position-relative mb-4">
            <div id= "previewKL">
                
            </div>
        </div>
        <div class="position-relative mb-4">
            <div id= "resultKL" class="img-thumbnail">
                <div id="klChart">
                </div> 
                <hr>
                <div id="varianChart">
                </div>
            </div>
        </div>         
    </div>
</div>
<script>
    //get ip
    var sockhost = "";
    var roomid = "";

    var screenH = "";
    var screenHchat = "";
    var screenHxray = "";
    var socket = "";
    var step = 0;
    var htmlobj="";
    var imglink="";
    function gethttpapi(url, dataget, level){
        var settings = {
        "async": true,
        "crossDomain": true,
        "url": url,
        "method": "GET",
        "headers": {
            "Content-Type": "application/json",
        },
        "data": dataget
        }
        $.ajax(settings).done(function (response) {
            //console.log(response);
            if(response.rep.result == "0"){
                if(level == "2"){
                    apiroot = response.rep.message + "api";
                    sockhost = response.rep.message.substr(0,response.rep.message.length -1);

                    screenH = window.innerHeight;
                    screenHchat = screenH * 0.7;
                    screenHxray = screenH * 0.8;
                
                    //var sockhost = apiroot;
                    $("#loadingx").hide();
                    $("#previewImg").hide();
                    $("#previewKL").hide();
                    $("#resultKL").hide();
                    $("#arrresult").hide();
                    $("#btnView").hide();
                    $("#textdect").hide();
                    

                    //create WebSocket connection.
                    socket = io.connect(sockhost);

                    socket.on("connect", () => {
                        //alert(screenH);
                        var screenH = window.innerHeight;  
                        //alert(screenH);     
                    })
                    // Listen for messages
                    //alert("=========222=========+>"+ roomid);  
                    //$('#linkdetect').empty();
                    socket.on(roomid, msg => {
                        //alert(JSON.stringify(msg));
                        if(msg != null){
                            
                            //msg.imgDecurl  msg.imgOricurl msg.listdetected

                            //rebuil IMG
                            $('#loadingx').hide();
                            $("#arrresult").empty();
                            htmlimglink = `<a href="`+ msg.imgDecurl +`" target="_blank">
                            <img id="im`+0+`" src="`+ msg.imgDecurl +`" class="img-thumbnail" alt="c1"/> </a><br><br>`;
                            $("#arrresult").append(htmlimglink);   
                            
                            $("#textdect").empty();
                            //alert(msg.dectlist);
                            htmlimglink2 = `<div class="img-thumbnail">`+msg.dectlist+`</div>`;
                            $("#textdect").append(htmlimglink2);
                            $("#textdect").show();
                            $("#arrresult").show();
                
                            //renew img origin link
                            $("#previewImg").empty();
                            htmlimgdec = `<a href="`+ msg.imgOricurl +`" target="_blank"><img id="preview" src="`+ msg.imgOricurl +`" class="img-thumbnail" alt="c1"/> </a><br><br>`;

                            $('#previewImg').append(htmlimgdec);
                            $("#previewImg").show();
                            //alert(msg.dectlist); 

                        }
                    });  

                }
            }
            else{
                //alert(response.rep.message);
            }
        });

    };
    gethttpapi(apiroot + "/apilink?api=wth",{},"2");

    //check Xquang
    $(document).on("click", ".browse", function() {
        $("#previewImg").show();
        //$("#arrresult").show();
        var file = $(this).parents().find(".file");
        file.trigger("click");
    });
    $('input[type="file"]').change(function(e) {
        $("#previewImg").show();
        //$("#arrresult").show();
        var fileName = e.target.files[0].name;
        $("#file").val(fileName);
    
        var reader = new FileReader();
        reader.onload = function(e) {
            $("#previewImg").empty();
            htmlimg = `<a href="`+sockhost+`/_shared/`+ fileName+`" target="_blank"><img id="preview" src="`+e.target.result+`" class="img-thumbnail" alt="c1"/> </a><br><br>`;
            $("#previewImg").append(htmlimg);
            //$("#previewImg").css("width",screenWxrayviewOri);
        };

        // read the image file as a data URL.
        reader.readAsDataURL(this.files[0]);
    });
    $("#btnReset").click(function(e){
        $("#btnView").show();
        $("#btnReset").hide();
        $("#previewImg").hide();
        $("#previewKL").hide();
        $("#resultKL").hide();
        $("#arrresult").hide();
        $("#textdect").hide();
    });
    $("#btnView").click(function(e){
        $("#btnReset").show();
        $("#btnView").hide();
        $("#previewKL").show();
        $("#resultKL").show();
        $("#previewImg").show();
        $("#arrresult").show();
        $("#textdect").show();
    });
    var listdetected = "";

    function btnKLfunc(){
		//tp35.3;tp36;tp35.2;tp35.2;tp32.2;tp32.2;tt34.5;tt34;tt33;tt32.5;tt34;tt34;cp34.5;cp34.5;cp34.5;cp34.5;cp34.5;cp34.5;ct33.5;ct31;ct32.5;ct33;ct32.5;ct32.5;


        if (!/^[a-z0-9.;]+$/.test($("#inkl").val())) {
            alert("Không đúng mẫu dữ liệu.\nCần sử dụng mẫu: tp35.3;tp36;tp35.2;tt34;tt33...");
        }
        else{    
            var sklArr = []
            const inkl = $("#inkl").val();
		    sklArr = inkl.split(";");
            if (sklArr.length < 24) {
                alert("Không đủ mẫu dữ liệu.\nCần 24 mẫu 12 kinh lạc nơi 10 ngón tay, 12 kinh lạc của 10 ngón chân.");
            }
            else{
                const data = `{"skl\":\"` 
                        + inkl 
                        + `\"}`;
                $('#loadingx').show();
                return fetch(apiroot+'/kinhlac', {
                    method: 'POST',
                    headers: { 'Content-type': 'application/json' },
                    body: data
                })
                .then(res => res.json())
                .then(data => {
                        $('#loadingx').hide();
                        //alert(JSON.stringify(data))
                        if(data.rep.result == '1'){
                            alert(data.rep.message)
                        }
                        else{
                            //alert(JSON.stringify(data.rep.message))

                            $("#previewKL").show();
                            $("#resultKL").show();
                            //previewKL
                            $("#previewKL").empty();
                            htmlimg = `
                            <div class="img-thumbnail">
                                <a href="`+data.rep.message.linkP+`" target="_blank">
                                    <div>
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Tay trái</th>
                                                    <th>Tay phải</th>
                                                    <th>Chân trái</th>
                                                    <th>Chân phải</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Tiểu trường 34.5</td>
                                                    <td>Tiểu trường 34.5</td>
                                                    <td>Bàng quang 34.5</td>
                                                    <td>Bàng quang 34.5</td>
                                                </tr>
                                                <tr>
                                                    <td>Tâm 34.5</td>
                                                    <td>Tâm 34.5</td>
                                                    <td>Thận 34.5</td>
                                                    <td>Thận 34.5</td>
                                                </tr>
                                                <tr>
                                                    <td>Tam tiêu 34.5</td>
                                                    <td>Tam tiêu 34.5</td>
                                                    <td>Đảm 34.5</td>
                                                    <td>Đảm 34.5</td>
                                                </tr>
                                                <tr>
                                                    <td>Tâm bào 34.5</td>
                                                    <td>Tâm bào 34.5</td>
                                                    <td>Vị 34.5</td>
                                                    <td>Vị 34.5</td>
                                                </tr>
                                                <tr>
                                                    <td>Đại trường 34.5</td>
                                                    <td>Đại trường 34.5</td>
                                                    <td>Cam 34.5</td>
                                                    <td>Cam 34.5</td>
                                                </tr>
                                                <tr>
                                                    <td>Phế 34.5</td>
                                                    <td>Phế 34.5</td>
                                                    <td>Tỳ 34.5</td>
                                                    <td>Tỳ 34.5</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </a>
                            </div><br><br>`;
                            
                            $("#previewKL").append(htmlimg);
                            //create chart
                            CanvasJS.addColorSet("greenShades",
                                [//colorSet Array
                                "#fc7f12",
                                "#17a2b8",
                                "#0f7485",
                                "#129eb5",
                                "#17b9d4",
                                "#18d5f5",
                                "#10e6d4",
                                "#10c9ba",
                                "#0da195",
                                "#0a8076",
                                "#246e4d",
                                "#339c6d",
                                "#3fc489",
                                "#4ae8a2"   
                                ]);
                            var chart = new CanvasJS.Chart("klChart", {
                                animationEnabled: true,
                                colorSet: "greenShades",
                                title:{
                                    text: "So sánh với các bệnh án khác ",
                                    fontSize: 24
                                },	
                                axisY: {
                                    title: "Mức nhiệt (độ C)",
                                    titleFontSize: 24,
                                    titleFontColor: "#4F81BC",
                                    lineColor: "#4F81BC",
                                    labelFontColor: "#4F81BC",
                                    tickColor: "#4F81BC"
                                },	
                                toolTip: {
                                    shared: true
                                },
                                legend: {
                                    cursor:"pointer",
                                    itemclick: toggleDataSeries
                                },
                                data: [
                                {
                                    type: "column",
                                    name: "Từ bệnh nhân",
                                    legendText: "Từ bệnh nhân",
                                    showInLegend: true, 
                                    dataPoints:[
                                        { label: "Tiểu trường", y: 34.2 },
                                        { label: "Tâm", y: 35.5 },
                                        { label: "Tam tiêu", y: 36 },
                                        { label: "Tâm bào", y: 35 },
                                        { label: "Đại trường", y: 36 },
                                        { label: "Phế", y: 36 },
                                        { label: "Bàng quang", y: 35 },
                                        { label: "Thận", y: 34.5 },
                                        { label: "Đảm", y: 36 },
                                        { label: "Vị", y: 35 },
                                        { label: "Cam", y: 35 },
                                        { label: "Tỳ", y: 34.5 }
                                    ]
                                },
                                    {
                                    type: "column",
                                    name: "Cảm cúm",
                                    legendText: "Cảm cúm",
                                    showInLegend: true, 
                                    dataPoints:[
                                        { label: "Tiểu trường", y: 32.2 },
                                        { label: "Tâm", y: 34.5 },
                                        { label: "Tam tiêu", y: 35 },
                                        { label: "Tâm bào", y: 32 },
                                        { label: "Đại trường", y: 32 },
                                        { label: "Phế", y: 34.5 },
                                        { label: "Bàng quang", y: 32.2 },
                                        { label: "Thận", y: 34.5 },
                                        { label: "Đảm", y: 35 },
                                        { label: "Vị", y: 32 },
                                        { label: "Cam", y: 32 },
                                        { label: "Tỳ", y: 34.5 }
                                    ]
                                },
                                {
                                    type: "column",	
                                    name: "Sốt cao",
                                    legendText: "Sốt cao",
                                    axisYType: "secondary",
                                    showInLegend: true,
                                    dataPoints:[
                                        { label: "Tiểu trường", y: 35.2 },
                                        { label: "Tâm", y: 36 },
                                        { label: "Tam tiêu", y: 37 },
                                        { label: "Tâm bào", y: 36 },
                                        { label: "Đại trường", y: 38 },
                                        { label: "Phế", y: 36.5 },
                                        { label: "Bàng quang", y: 36 },
                                        { label: "Thận", y: 35.5 },
                                        { label: "Đảm", y: 37 },
                                        { label: "Vị", y: 38 },
                                        { label: "Cam", y: 38 },
                                        { label: "Tỳ", y: 37.5 }
                                    ]
                                },
                                {
                                    type: "column",	
                                    name: "Hen",
                                    legendText: "Hen",
                                    axisYType: "secondary",
                                    showInLegend: true,
                                    dataPoints:[
                                        { label: "Tiểu trường", y: 35.2 },
                                        { label: "Tâm", y: 32 },
                                        { label: "Tam tiêu", y: 32 },
                                        { label: "Tâm bào", y: 32 },
                                        { label: "Đại trường", y: 33 },
                                        { label: "Phế", y: 33.5 },
                                        { label: "Bàng quang", y: 31 },
                                        { label: "Thận", y: 32.5 },
                                        { label: "Đảm", y: 34 },
                                        { label: "Vị", y: 33 },
                                        { label: "Cam", y: 35 },
                                        { label: "Tỳ", y: 34.5 }
                                    ]
                                },
                                {
                                    type: "column",	
                                    name: "Ðau lợi răng",
                                    legendText: "Ðau lợi răng",
                                    axisYType: "secondary",
                                    showInLegend: true,
                                    dataPoints:[
                                        { label: "Tiểu trường", y: 33.2 },
                                        { label: "Tâm", y: 32 },
                                        { label: "Tam tiêu", y: 34 },
                                        { label: "Tâm bào", y: 32 },
                                        { label: "Đại trường", y: 32 },
                                        { label: "Phế", y: 35.5 },
                                        { label: "Bàng quang", y: 33 },
                                        { label: "Thận", y: 35.5 },
                                        { label: "Đảm", y: 33 },
                                        { label: "Vị", y: 35 },
                                        { label: "Cam", y: 32 },
                                        { label: "Tỳ", y: 35.5 }
                                    ]
                                }
                                ,
                                {
                                    type: "column",	
                                    name: "Ðau bụng",
                                    legendText: "Ðau bụng",
                                    axisYType: "secondary",
                                    showInLegend: true,
                                    dataPoints:[
                                        { label: "Tiểu trường", y: 35.2 },
                                        { label: "Tâm", y: 34.2 },
                                        { label: "Tam tiêu", y: 35 },
                                        { label: "Tâm bào", y: 33 },
                                        { label: "Đại trường", y: 36 },
                                        { label: "Phế", y: 32.5 },
                                        { label: "Bàng quang", y: 36 },
                                        { label: "Thận", y: 31.5 },
                                        { label: "Đảm", y: 32 },
                                        { label: "Vị", y: 31 },
                                        { label: "Cam", y: 31.5 },
                                        { label: "Tỳ", y: 32.5 }
                                    ]
                                }
                                ,
                                {
                                    type: "column",	
                                    name: "Hôn mê",
                                    legendText: "Hôn mê",
                                    axisYType: "secondary",
                                    showInLegend: true,
                                    dataPoints:[
                                        { label: "Tiểu trường", y: 33.2 },
                                        { label: "Tâm", y: 31 },
                                        { label: "Tam tiêu", y: 32 },
                                        { label: "Tâm bào", y: 32 },
                                        { label: "Đại trường", y: 35 },
                                        { label: "Phế", y: 32.5 },
                                        { label: "Bàng quang", y: 36 },
                                        { label: "Thận", y: 33.5 },
                                        { label: "Đảm", y: 32 },
                                        { label: "Vị", y: 32 },
                                        { label: "Cam", y: 34.3 },
                                        { label: "Tỳ", y: 33.5 }
                                    ]
                                }
                            ]
                            });
                            chart.render();
                            var chart2 = new CanvasJS.Chart("varianChart", {
                                animationEnabled: true,
                                colorSet: "greenShades",
                                title:{
                                    text: "Số tương quan",
                                    fontSize: 24
                                },	
                                axisY: {
                                    title: "Mức tương quan (độ C)",
                                    titleFontSize: 24,
                                    titleFontColor: "#4F81BC",
                                    lineColor: "#4F81BC",
                                    labelFontColor: "#4F81BC",
                                    tickColor: "#4F81BC"
                                },	
                                toolTip: {
                                    shared: true
                                },
                                legend: {
                                    cursor:"pointer",
                                    itemclick: toggleDataSeries
                                },
                                data: [
                                {
                                    type: "column",
                                    name: "Từ bệnh nhân",
                                    legendText: "Từ bệnh nhân",
                                    fontSize: 12,
                                    showInLegend: true, 
                                    dataPoints:[
                                        { label: "SSGH chi trên", y: 0.7 },
                                        { label: "SSGH chi dưới", y: 0.2 },
                                        { label: "CLTB 2 chi", y: 0.5 },
                                        { label: "SS (+) Tiểu trường", y: 1.2 },
                                        { label: "SS (+) Tâm", y: 0.5 },
                                        { label: "SS (+) Tam tiêu", y: 0.9 },
                                        { label: "SS (+) Tâm bào", y: 0.4 },
                                        { label: "SS (+) Đại trường", y: 1.2 },
                                        { label: "SS (+) Phế", y: 0.2 },
                                        { label: "SS (+) Bàng quang", y: 1.5 },
                                        { label: "SS (+) Thận", y: 0.5 },
                                        { label: "SS (+) Đảm", y: 0.6 },
                                        { label: "SS (+) Vị", y: 0.8 },
                                        { label: "SS (+) Cam", y: 0.5 },
                                        { label: "SS (+) Tỳ", y: 0.9 },
                                        { label: "SS (-) Tiểu trường", y: 1.2 },
                                        { label: "SS (-) Tâm", y: 0.7 },
                                        { label: "SS (-) Tam tiêu", y: 1.3 },
                                        { label: "SS (-) Tâm bào", y: 1.5 },
                                        { label: "SS (-) Đại trường", y: 0.6 },
                                        { label: "SS (-) Phế", y: 0.8 },
                                        { label: "SS (-) Bàng quang", y: 0.5 },
                                        { label: "SS (-) Thận", y: 0.5 },
                                        { label: "SS (-) Đảm", y: 0.4 },
                                        { label: "SS (-) Vị", y: 0.8 },
                                        { label: "SS (-) Cam", y: 0.7 },
                                        { label: "SS (-) Tỳ", y: 0.5 }
                                    ]
                                }
                            ]
                            });
                            chart2.render();

                            function toggleDataSeries(e) {
                                if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                                    e.dataSeries.visible = false;
                                }
                                else {
                                    e.dataSeries.visible = true;
                                }
                                chart.render();
                            }


                            //gui socket
                            //socket.emit(roomid,{"imgDecurl":"/_shared/680.png","imgOricurl":data.rep.message,"dectlist":""}); 
                            
                        }        
                })
            }
        }
    };
    //send KL
    $('#inkl').on('keypress', function(e) {
		if (e.keyCode == 13) {
			btnKLfunc();
		}
	});
    $("#btnkl").click(function(e){
        btnKLfunc();
    });    


    //send IMG
    $("#btnSendImg").click(function(e){
        const canvasdata = $("#preview").prop('src');
		if ((canvasdata.length < 20000) || (canvasdata.length > 700000) ){   
			alert("Đầu vào cần có tệp tin ảnh jpg/png, kích cỡ 1024, dung lượng 300kb.");
		}else{    
					$('#loadingx').show();
                    return fetch(apiroot+'/wtsendimg', {
						method: 'POST',
						headers: { 'Content-type': 'application/json' },
						body: JSON.stringify({ imgid: canvasdata })
					})
					.then(res => res.json())
					.then(data => {
                            //alert(data.rep.message);
							$('#loadingx').hide();
							//alert(JSON.stringify(data))
							if(data.rep.result == '1'){
								alert(data.rep.message)
							}
							else{
								if(data.rep.message.length == 0){
									alert("Ảnh quá bé!")
								}
								else{
                                    
                                    $("#previewImg").empty();
                                    htmlimg = `<a href="`+data.rep.message+`" target="_blank"><img id="preview" src="`+data.rep.message+`" class="img-thumbnail" alt="c1"/> </a><br><br>`;
                                    $("#previewImg").append(htmlimg);
                                    socket.emit(roomid,{"imgDecurl":"/_shared/680.png","imgOricurl":data.rep.message,"dectlist":""}); 
                                }
                            }
                        })                
				//}
			//})
		};                            
    });

    //check XQUang
    $("#btnSearchImg").click(function(e){
		const canvasdata = $("#preview").prop('src');
		if ((canvasdata.length < 20000) || (canvasdata.length > 700000) ){   
			alert("Đầu vào cần có tệp tin ảnh jpg/png, kích cỡ 1024, dung lượng 300kb.");
		}else{    
					$('#loadingx').show();
					return fetch(apiroot+'/vinsearchimg', {
						method: 'POST',
						headers: { 'Content-type': 'application/json' },
						body: JSON.stringify({ imgid: canvasdata })
					})
					.then(res => res.json())
					.then(data => {
							$('#loadingx').hide();
							//alert(JSON.stringify(data))
							if(data.rep.result == '1'){
								alert(data.rep.message)
							}
							else{
								if(data.rep.message.length == 0){
									alert("Ảnh quá bé!")
								}
								else{
                                    $("#arrresult").show();
									$("#arrresult").empty();
									//$("#searchno").hide();
									//$("#searchyes").show();
									//console.log(data.rep.message.length)
									$("#numresult").text(data.rep.message.length-1)

                                    //add img detect link
									htmlhead = `<a href="`+sockhost+`/_shared/`+ data.rep.message[0]+`" target="_blank">
									<img id="im`+0+`" src="`+sockhost+`/_shared/`+ data.rep.message[0]+`" class="img-thumbnail" alt="c1"/> </a><br><br>`;
                                    imglink = sockhost+`/_shared/` + data.rep.message[0];
									$("#arrresult").append(htmlhead);
                                    
                                    imgorilink = imglink.substr(0,imglink.indexOf("_de"))+".jpg";
                                    //alert(imgorilink);

                                    //renew img origin link
                                    $("#previewImg").empty();
                                    htmlimg = `<a href="`+imgorilink+`" target="_blank"><img id="preview" src="`+imgorilink+`" class="img-thumbnail" alt="c1"/> </a><br><br>`;
                                    $("#previewImg").append(htmlimg);

									//htmlbody = `` ;
                                    
									for(var i=1; i<data.rep.message.length ;i++){
										var name = '';
										if(data.rep.message[i].split("#")[0] == "0")
											 name = 'Aortic enlargement - Rộng động mạch chủ'
										else if(data.rep.message[i].split("#")[0] == "8")
											 name = 'Nodule/Mass - Tổn thương lành tính'											 
										else if(data.rep.message[i].split("#")[0] == "7")
											 name = 'Lung Opacity - Mờ phổi'	
										else if(data.rep.message[i].split("#")[0] == "1")
											 name = 'Atelectasis - Xẹp phổi'	
										else if(data.rep.message[i].split("#")[0] == "2")
											 name = 'Calcification - Vôi hóa'	
										else if(data.rep.message[i].split("#")[0] == "3")
											 name = 'Cardiomegaly - Tim to'	
										else if(data.rep.message[i].split("#")[0] == "4")
											 name = 'Consolidation - Bị đông đặc'	
										else if(data.rep.message[i].split("#")[0] == "5")
											 name = 'ILD - Phổi mô kẽ'												 											 
										else if(data.rep.message[i].split("#")[0] == "6")
											 name = 'Infiltration - Có xâm nhiễm lao'
										else if(data.rep.message[i].split("#")[0] == "9")
											 name = 'Other lesion - Tổn thương khác'
										else if(data.rep.message[i].split("#")[0] == "10")
											 name = 'Pleural effusion - Tràn dịch màng phổi'
										else if(data.rep.message[i].split("#")[0] == "11")
											 name = 'Pleural thickening - Dày màng phổi'
										else if(data.rep.message[i].split("#")[0] == "12")
											 name = 'Pneumothorax - Tràn khí màng phổi'
										else if(data.rep.message[i].split("#")[0] == "13")
											 name = 'Pulmonary fibrosis - Xơ phổi'

										//htmlbody = `<p>`+name+ ` ...có dự đoán tin cậy ` +data.rep.message[i].split("#")[1]+`</p>`
                                        
                                        listdetected = listdetected + `<a>`+ name + ` ...có dự đoán tin cậy ` +data.rep.message[i].split("#")[1] + `</a>` + '<br>';
										//$("#arrresult").append(htmlbody);
									}
                                    //send to chat   
                                    //send sock
                                    socket.emit(roomid,{"imgDecurl":imglink,"imgOricurl":imgorilink,"dectlist":listdetected}); 
								}
							}
							//alert(data.message); 
					})
				//}
			//})
		};
        
	});
    //update loop to check screen size
    (function getscreenH(i3) {
        setTimeout(function() {
            screenH = window.innerHeight; 
            screenW = window.innerWidth; 
            //reset position chatbot, xraydetection
            screenHxray = screenH * 0.75;
            screenHxrayview = screenH * 0.1;
            screenWxrayviewOri = screenH * 0.5;
            screenHklH = screenH * 0.35;
            screenHklW = screenW * 0.65;
            screenHklHs = screenH * 0.08;
            screenHklWs = screenW * 0.12;

            $("#previewImg").css("width",screenWxrayviewOri);
            $("#arrresult").css("width",screenWxrayviewOri);
            //alert(screenH + "---------" + (screenH - posY) * 0.3 );
            //$(".widget-container").css("margin","0 20px " + (screenH - posY) * 0.3 + " 0");
            $(".widget-container").css("margin","0 20px " + (screenH) * 0.52 + " 0");
            $("#xraycontrol").css("margin","0 20px " + screenHxray + " 0");
            $("#loadingx").css("margin","0 20px " + (screenHxray - 70) + " 0");
            $("#xrayview").css("margin","0 150px " + screenHxrayview + " 0");
            $("#klview").css("margin","0 " + screenHklWs +"px " + screenHklHs + "px 0");
            $("#klChart").css("width",screenHklW +"px");
            $("#klChart").css("height",screenHklH +"px");
            $("#varianChart").css("width",screenHklW +"px");
            $("#varianChart").css("height",screenHklH +"px");
            
            if (--i3) {
                getscreenH(i3);
            }	
        }, 3000)
    })(2000000);
    
</script>    
<div id="webchat"/>
<%-stream %>
</body>
</html>